---

- hosts: server
  remote_user: root  # TODO: ubuntu
  gather_facts: no
  tasks:
  - git:
      repo: git@github.com:her0e1c1/pystock.git
      dest: ~/pystock
      update: yes
      force: yes
      accept_hostkey: True

  - cron:
      cron_file: pystock
      user: docker
      hour: 0
      job: "pystock quandl import-all-codes TSE | 2>&1 | logger -t pystock -p local0.info"

  - copy:
      src: ../.env
      dest: ~/pystock
      mode: 0644

  - docker_image:
      path: ~/pystock
      name: pystock

  - docker_service:
      files:
        - docker-compose.yml
        - docker-compose.prod.yml
      project_src: ~/pystock
      build: yes
      restarted: yes
